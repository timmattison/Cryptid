[manifest]
version = "1.0.0"
dump_lua = true
priority = -1

# Is this a joke? Deck - Legendary/Exotic Jokers in shop
# This patch adds a chance for legendary and exotic jokers to appear in shop when the deck modifier is active

[[patches]]
[patches.pattern]
target = "game.lua"
pattern = '''if G.load_shop_booster then'''
position = "before"
payload = '''
if G.GAME.modifiers.cry_is_this_a_joke then
    -- 4x odds means ~1/80 base chance per shop slot becomes ~1/20
    -- Check for each shop joker slot if we should spawn a legendary or exotic
    local slots = G.GAME.shop.joker_max or 2
    for i = 1, slots do
        local roll = pseudorandom('cry_itaj_legendary' .. G.GAME.round_resets.ante .. '_' .. i)
        -- Legendary: base ~1/1000 in vanilla soul, we make it ~1/250 (4x)
        -- For shop appearance, let's use 1/50 chance per slot
        if roll < 0.02 then -- 2% = 1/50 chance
            local card = create_card('Joker', G.shop_jokers, true, 4, nil, nil, nil, 'cry_itaj')
            Cryptid.manipulate(card)
            create_shop_card_ui(card, 'Joker', G.shop_jokers)
            card:start_materialize()
            G.shop_jokers.config.card_limit = G.shop_jokers.config.card_limit + 1
            G.shop_jokers:emplace(card)
        elseif roll < 0.04 and Cryptid.enabled('set_cry_exotic') then -- 2% = 1/50 chance for exotic
            local card = create_card('Joker', G.shop_jokers, nil, 'cry_exotic', nil, nil, nil, 'cry_itaj')
            Cryptid.manipulate(card)
            create_shop_card_ui(card, 'Joker', G.shop_jokers)
            card:start_materialize()
            G.shop_jokers.config.card_limit = G.shop_jokers.config.card_limit + 1
            G.shop_jokers:emplace(card)
        end
    end
end
'''
match_indent = true
